import streamlit as st
import pandas as pd
import plotly.express as px
import smtplib
from email.message import EmailMessage

# ===============================
# ุฅุนุฏุงุฏ ุงูุตูุญุฉ
# ===============================
st.set_page_config(
    page_title="ููุญุฉ ูุชุงุจุนุฉ ุฃุฏุงุก ุงููุนููุงุช",
    layout="wide"
)

# ===============================
# ุงูุดุนุงุฑ ูุงูุนููุงู
# ===============================
col_logo, col_title = st.columns([1, 5])

with col_logo:
    st.image("logo.png", width=120)  # ุถุนู ุดุนุงุฑ ุงููุฏุฑุณุฉ ุจุงุณู logo.png

with col_title:
    st.markdown("## ๐ ููุญุฉ ูุชุงุจุนุฉ ุฃุฏุงุก ุงููุนููุงุช โ ุงูุฅุฏุงุฑุฉ ุงูุชุนููููุฉ")
    st.markdown("ูุธุงู ุฐูู ููุชุงุจุนุฉ ุงูุฃุฏุงุก ุงูุฃุณุจูุนู")

st.divider()

# ===============================
# ุฑูุน ุงูููู
# ===============================
uploaded_file = st.file_uploader(
    "๐ ุงุฑูุนู ููู Excel (ุงูุจูุงูุงุช ุงููุงุฏูุฉ ูู Google Form)",
    type=["xlsx"]
)

if uploaded_file is None:
    st.info("โฌ๏ธ ุจุงูุชุธุงุฑ ุฑูุน ููู ุงูุจูุงูุงุช")
    st.stop()

df = pd.read_excel(uploaded_file)

# ===============================
# ุชูุธูู ุงูุจูุงูุงุช
# ===============================
df = df.dropna(subset=["ุงุณู ุงููุนููุฉ"])
df["ุนุฏุฏ ุงูููุงูุต"] = pd.to_numeric(df["ุนุฏุฏ ุงูููุงูุต"], errors="coerce").fillna(0)

# ===============================
# ุงููุคุดุฑุงุช ุงูุนุงูุฉ
# ===============================
st.subheader("๐ ุงููุคุดุฑุงุช ุงูุนุงูุฉ")

c1, c2, c3, c4 = st.columns(4)

ุนุฏุฏ_ุงููุนููุงุช = df["ุงุณู ุงููุนููุฉ"].nunique()
ุนุฏุฏ_ุงูููุงูุต_ุงูููู = int(df["ุนุฏุฏ ุงูููุงูุต"].sum())
ุนุฏุฏ_ุงูููุชููุงุช = (df["ุงูุชูููู ุงูุนุงู"] == "๐ ููุชุงุฒ").sum()
ุนุฏุฏ_ูุญุชุงุฌ_ูุชุงุจุนุฉ = (df["ุงูุชูููู ุงูุนุงู"] == "โ๏ธ ูุญุชุงุฌ ูุชุงุจุนุฉ").sum()

c1.metric("๐ฉโ๐ซ ุนุฏุฏ ุงููุนููุงุช", ุนุฏุฏ_ุงููุนููุงุช)
c2.metric("โ ุนุฏุฏ ุงูููุงูุต ุงูููู", ุนุฏุฏ_ุงูููุงูุต_ุงูููู)
c3.metric("๐ ุงูููุชููุงุช", ุนุฏุฏ_ุงูููุชููุงุช)
c4.metric("โ๏ธ ูุญุชุงุฌ ูุชุงุจุนุฉ", ุนุฏุฏ_ูุญุชุงุฌ_ูุชุงุจุนุฉ)

# ===============================
# ุฌุฏูู ุงูุจูุงูุงุช
# ===============================
st.subheader("๐ ุฌุฏูู ุงููุชุงุจุนุฉ ุงูุชูุตููู")
st.dataframe(df, use_container_width=True)

# ===============================
# ุฑุณู ุชูุฒูุน ุงูููุงูุต (Plotly)
# ===============================
st.subheader("๐ ุชูุฒูุน ุงูููุงูุต ููู ูุนููุฉ")

fig_bar = px.bar(
    df,
    x="ุงุณู ุงููุนููุฉ",
    y="ุนุฏุฏ ุงูููุงูุต",
    color="ุนุฏุฏ ุงูููุงูุต",
    color_continuous_scale="Blues",
    text="ุนุฏุฏ ุงูููุงูุต"
)

fig_bar.update_layout(
    xaxis_title="ุงุณู ุงููุนููุฉ",
    yaxis_title="ุนุฏุฏ ุงูููุงูุต",
    title=None
)

st.plotly_chart(fig_bar, use_container_width=True)

# ===============================
# ุฑุณู ุงูุชูููู ุงูุนุงู
# ===============================
st.subheader("๐ฅง ูุณุจุฉ ุงูุชูููู ุงูุนุงู")

fig_pie = px.pie(
    df,
    names="ุงูุชูููู ุงูุนุงู",
    hole=0.4,
    color_discrete_sequence=px.colors.sequential.Blues
)

st.plotly_chart(fig_pie, use_container_width=True)

# ===============================
# ุชุญููู ุฐูู (AI-like)
# ===============================
st.subheader("๐ง ุงูุชุญููู ุงูุฐูู ููุฅุฏุงุฑุฉ")

def smart_comment(row):
    if row["ุงูุชูููู ุงูุนุงู"] == "๐ ููุชุงุฒ":
        return "ุฃุฏุงุก ูุชููุฒุ ูููุตุญ ุจุงูุชูุฑูู ุฃู ุงููุดุงุฑูุฉ ูู ุชุจุงุฏู ุงูุฎุจุฑุงุช."
    elif row["ุงูุชูููู ุงูุนุงู"] == "๐ ุฌูุฏ":
        return "ุฃุฏุงุก ุฌูุฏ ูุน ูุฑุต ุจุณูุทุฉ ููุชุญุณูู."
    else:
        return "ุชุญุชุงุฌ ูุชุงุจุนุฉ ูุฏุนู ูุจุงุดุฑ ุฎูุงู ุงูุฃุณุจูุน ุงููุงุฏู."

df["ููุงุญุธุฉ ุฐููุฉ"] = df.apply(smart_comment, axis=1)
st.dataframe(df[["ุงุณู ุงููุนููุฉ", "ุงูุชูููู ุงูุนุงู", "ููุงุญุธุฉ ุฐููุฉ"]], use_container_width=True)

# ===============================
# ุฅุฑุณุงู ุงูุฅูููู (ุจุงุณุชุฎุฏุงู Secrets)
# ===============================
def send_email(to_email, teacher_name, evaluation, missing_count):
    msg = EmailMessage()
    msg["Subject"] = "๐ ุชูุฑูุฑ ุงููุชุงุจุนุฉ ุงูุฃุณุจูุนู"
    msg["From"] = st.secrets["EMAIL_USER"]
    msg["To"] = to_email

    msg.set_content(f"""
ุงูุณูุงู ุนูููู {teacher_name}

๐ ุชูุฑูุฑ ุงููุชุงุจุนุฉ ุงูุฃุณุจูุนู:

๐น ุงูุชูููู ุงูุนุงู: {evaluation}
๐น ุนุฏุฏ ุงูููุงูุต: {missing_count}

ูุน ุชูููุงุชูุง ูู ุจุงูุชูููู ๐ธ
ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ
""")

    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
        server.login(
            st.secrets["EMAIL_USER"],
            st.secrets["EMAIL_PASS"]
        )
        server.send_message(msg)

# ===============================
# ุฒุฑ ุงูุฅุฑุณุงู
# ===============================
st.subheader("๐ง ุฅุฑุณุงู ุงูุชููููุงุช ุชููุงุฆููุง")

if st.button("๐ ุฅุฑุณุงู ุงูุชูุงุฑูุฑ ูุฌููุน ุงููุนููุงุช"):
    for _, row in df.iterrows():
        send_email(
            row["ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุนููุฉ"],
            row["ุงุณู ุงููุนููุฉ"],
            row["ุงูุชูููู ุงูุนุงู"],
            int(row["ุนุฏุฏ ุงูููุงูุต"])
        )

    st.success("โ ุชู ุฅุฑุณุงู ุฌููุน ุงูุชูุงุฑูุฑ ุจูุฌุงุญ")
