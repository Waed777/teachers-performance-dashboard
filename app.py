import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import smtplib
from email.message import EmailMessage

# ===============================
# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©
# ===============================
st.set_page_config(
    page_title="Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª â€“ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ù†Ù‡Ù„",
    layout="wide"
)

# ===============================
# ØªÙ†Ø³ÙŠÙ‚ CSS (Ø¹Ø±Ø¨ÙŠ + Ø£Ø²Ø±Ù‚)
# ===============================
st.markdown("""
<style>
body {
    direction: rtl;
}
h1, h2, h3 {
    color: #0A3D62;
}
.metric-box {
    background-color: #EAF2F8;
    padding: 15px;
    border-radius: 12px;
    text-align: center;
}
</style>
""", unsafe_allow_html=True)

# ===============================
# Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†
# ===============================
col1, col2 = st.columns([1, 6])

with col1:
    st.image("__Ø´Ø¹Ø§Ø±1_.png", width=120)

with col2:
    st.markdown("## ğŸ“ Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª â€“ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ù†Ù‡Ù„")
    st.markdown("### Ù…Ù†ØµØ© Ø°ÙƒÙŠØ© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ")

st.divider()

# ===============================
# Ø±ÙØ¹ Ù…Ù„Ù Excel
# ===============================
uploaded_file = st.file_uploader(
    "ğŸ“‚ Ø§Ø±ÙØ¹ÙŠ Ù…Ù„Ù Excel (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Google Form)",
    type=["xlsx"]
)

if uploaded_file is None:
    st.info("â¬†ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨Ø¯Ø¡")
    st.stop()

df = pd.read_excel(uploaded_file)

# ===============================
# ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# ===============================
df = df.dropna(subset=["Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©"])
df["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"] = pd.to_numeric(df["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"], errors="coerce").fillna(0)

# ===============================
# Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
# ===============================
st.subheader("ğŸ“Š Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©")

c1, c2, c3, c4 = st.columns(4)

c1.metric("ğŸ‘©â€ğŸ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª", df["Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©"].nunique())
c2.metric("âŒ Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ Ø§Ù„ÙƒÙ„ÙŠ", int(df["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"].sum()))
c3.metric("ğŸŒŸ Ù…Ù…ØªØ§Ø²", (df["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"] == "ğŸŒŸ Ù…Ù…ØªØ§Ø²").sum())
c4.metric("âš ï¸ ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©", (df["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"] == "âš ï¸ ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©").sum())

# ===============================
# Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
# ===============================
st.subheader("ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ")
st.dataframe(df, use_container_width=True)

# ===============================
# Ø±Ø³Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
# ===============================
st.subheader("ğŸ“ˆ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ Ù„ÙƒÙ„ Ù…Ø¹Ù„Ù…Ø©")

fig, ax = plt.subplots()
ax.bar(df["Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©"], df["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"], color="#1E88E5")
ax.set_ylabel("Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ")
ax.set_xlabel("Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©")
plt.xticks(rotation=45, ha="right")
st.pyplot(fig)

# ===============================
# Ø±Ø³Ù… Ø¯Ø§Ø¦Ø±ÙŠ
# ===============================
st.subheader("ğŸ¥§ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…")

rating_counts = df["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"].value_counts()

fig2, ax2 = plt.subplots()
ax2.pie(
    rating_counts,
    labels=rating_counts.index,
    autopct="%1.1f%%",
    startangle=90,
    colors=["#1565C0", "#42A5F5", "#90CAF9"]
)
ax2.axis("equal")
st.pyplot(fig2)

# ===============================
# ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ (AI Insight)
# ===============================
st.subheader("ğŸ§  Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø£Ø¯Ø§Ø¡")

def ai_note(row):
    if row["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"] == "ğŸŒŸ Ù…Ù…ØªØ§Ø²":
        return "Ø£Ø¯Ø§Ø¡ Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ â€“ Ù…Ø±Ø´Ø­Ø© Ù„Ù„ØªÙƒØ±ÙŠÙ…."
    elif row["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"] == "ğŸ™‚ Ø¬ÙŠØ¯":
        return "Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ â€“ ÙŠÙˆØµÙ‰ Ø¨Ø¯Ø¹Ù… Ø¨Ø³ÙŠØ·."
    else:
        return "ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø§Ø¬Ù„Ø© ÙˆØ®Ø·Ø© ØªØ­Ø³ÙŠÙ†."

df["ğŸ§  Ù…Ù„Ø§Ø­Ø¸Ø© Ø°ÙƒÙŠØ©"] = df.apply(ai_note, axis=1)

st.dataframe(
    df[["Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©", "Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…", "ğŸ§  Ù…Ù„Ø§Ø­Ø¸Ø© Ø°ÙƒÙŠØ©"]],
    use_container_width=True
)

# ===============================
# Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
# ===============================
def send_email(to_email, name, evaluation, missing):
    try:
        msg = EmailMessage()
        msg["Subject"] = "ğŸ“„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© â€“ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ù†Ù‡Ù„"
        msg["From"] = st.secrets["EMAIL_USER"]
        msg["To"] = to_email

        msg.set_content(f"""
Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… {name}

Ù‡Ø°Ø§ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:

ğŸ”¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: {evaluation}
ğŸ”¹ Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ: {missing}

Ù…Ø¹ ØªÙ…Ù†ÙŠØ§ØªÙ†Ø§ Ù„Ùƒ Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚ ğŸŒ¸
Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ù†Ù‡Ù„
""")

        with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
            server.login(
                st.secrets["EMAIL_USER"],
                st.secrets["EMAIL_PASS"]
            )
            server.send_message(msg)

        return True
    except:
        return False

# ===============================
# Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
# ===============================
st.subheader("ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")

if st.button("ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±"):
    success = 0
    fail = 0

    for _, row in df.iterrows():
        if send_email(
            row["Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…Ø©"],
            row["Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©"],
            row["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"],
            int(row["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"])
        ):
            success += 1
        else:
            fail += 1

    st.success(f"âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­: {success}")
    if fail > 0:
        st.warning(f"âš ï¸ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ {fail} Ù…Ø¹Ù„Ù…Ø§Øª")
