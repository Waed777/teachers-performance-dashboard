import streamlit as st
import pandas as pd
import plotly.express as px
import smtplib
from email.message import EmailMessage

# ===============================
# ุฅุนุฏุงุฏ ุงูุตูุญุฉ
# ===============================
st.set_page_config(
    page_title="ููุญุฉ ูุชุงุจุนุฉ ุฃุฏุงุก ุงููุนููุงุช",
    layout="wide"
)

# ===============================
# ุงูุดุนุงุฑ ูุงูุนููุงู
# ===============================
col1, col2 = st.columns([1, 6])

with col1:
    st.image("__ุดุนุงุฑ1_.png", width=120)

with col2:
    st.markdown("## ๐ ููุญุฉ ูุชุงุจุนุฉ ุฃุฏุงุก ุงููุนููุงุช โ ูุฏุงุฑุณ ุงููููู")
    st.markdown("### ูุธุงู ุฐูู ููุชุงุจุนุฉ ุงูุฃุฏุงุก ุงูุฃุณุจูุนู")

st.divider()

# ===============================
# ุฑูุน ุงูููู
# ===============================
uploaded_file = st.file_uploader(
    "๐ ุงุฑูุนู ููู Excel (ุงูุจูุงูุงุช ุงููุงุฏูุฉ ูู Google Form)",
    type=["xlsx"]
)

if uploaded_file is None:
    st.info("โฌ๏ธ ุจุงูุชุธุงุฑ ุฑูุน ููู ุงูุจูุงูุงุช")
    st.stop()

df = pd.read_excel(uploaded_file)

# ===============================
# ุชูุธูู ุงูุจูุงูุงุช
# ===============================
df = df.dropna(subset=["ุงุณู ุงููุนููุฉ"])
df["ุนุฏุฏ ุงูููุงูุต"] = pd.to_numeric(df["ุนุฏุฏ ุงูููุงูุต"], errors="coerce").fillna(0)

# ===============================
# ุงููุคุดุฑุงุช ุงูุนุงูุฉ
# ===============================
st.subheader("๐ ุงููุคุดุฑุงุช ุงูุนุงูุฉ")

c1, c2, c3, c4 = st.columns(4)

c1.metric("๐ฉโ๐ซ ุนุฏุฏ ุงููุนููุงุช", df["ุงุณู ุงููุนููุฉ"].nunique())
c2.metric("โ ุนุฏุฏ ุงูููุงูุต ุงูููู", int(df["ุนุฏุฏ ุงูููุงูุต"].sum()))
c3.metric("๐ ุงูููุชููุงุช", (df["ุงูุชูููู ุงูุนุงู"] == "๐ ููุชุงุฒ").sum())
c4.metric("โ๏ธ ูุญุชุงุฌ ูุชุงุจุนุฉ", (df["ุงูุชูููู ุงูุนุงู"] == "โ๏ธ ูุญุชุงุฌ ูุชุงุจุนุฉ").sum())

# ===============================
# ุงูุฌุฏูู
# ===============================
st.subheader("๐ ุฌุฏูู ุงููุชุงุจุนุฉ")
st.dataframe(df, use_container_width=True)

# ===============================
# ุฑุณู ุงูุฃุนูุฏุฉ
# ===============================
st.subheader("๐ ุชูุฒูุน ุงูููุงูุต")

fig_bar = px.bar(
    df,
    x="ุงุณู ุงููุนููุฉ",
    y="ุนุฏุฏ ุงูููุงูุต",
    color="ุนุฏุฏ ุงูููุงูุต",
    color_continuous_scale="Blues",
    text="ุนุฏุฏ ุงูููุงูุต"
)
st.plotly_chart(fig_bar, use_container_width=True)

# ===============================
# ุฑุณู ุฏุงุฆุฑู
# ===============================
st.subheader("๐ฅง ูุณุจุฉ ุงูุชูููู ุงูุนุงู")

fig_pie = px.pie(
    df,
    names="ุงูุชูููู ุงูุนุงู",
    hole=0.4,
    color_discrete_sequence=px.colors.sequential.Blues
)
st.plotly_chart(fig_pie, use_container_width=True)

# ===============================
# ุชุญููู ุฐูู (AI-style)
# ===============================
st.subheader("๐ง ุงูุชุญููู ุงูุฐูู")

def smart_note(row):
    if row["ุงูุชูููู ุงูุนุงู"] == "๐ ููุชุงุฒ":
        return "ุฃุฏุงุก ูุชููุฒ โ ูููุตู ุจุงูุชูุฑูู."
    elif row["ุงูุชูููู ุงูุนุงู"] == "๐ ุฌูุฏ":
        return "ุฃุฏุงุก ุฌูุฏ ูุน ูุฑุต ุชุญุณูู ุจุณูุทุฉ."
    else:
        return "ูุญุชุงุฌ ูุชุงุจุนุฉ ุนุงุฌูุฉ ูุฏุนู ูุจุงุดุฑ."

df["ููุงุญุธุฉ ุฐููุฉ"] = df.apply(smart_note, axis=1)
st.dataframe(df[["ุงุณู ุงููุนููุฉ", "ุงูุชูููู ุงูุนุงู", "ููุงุญุธุฉ ุฐููุฉ"]], use_container_width=True)

# ===============================
# ุฅุฑุณุงู ุงูุฅูููู
# ===============================
def send_email(to_email, name, evaluation, missing):
    msg = EmailMessage()
    msg["Subject"] = "๐ ุชูุฑูุฑ ุงููุชุงุจุนุฉ ุงูุฃุณุจูุนู โ ูุฏุงุฑุณ ุงููููู"
    msg["From"] = st.secrets["EMAIL_USER"]
    msg["To"] = to_email

    msg.set_content(f"""
ุงูุณูุงู ุนูููู {name}

๐ ุชูุฑูุฑ ุงููุชุงุจุนุฉ ุงูุฃุณุจูุนู:

ุงูุชูููู: {evaluation}
ุนุฏุฏ ุงูููุงูุต: {missing}

ูุน ุชูููุงุชูุง ูู ุจุงูุชูููู ๐ธ
ุฅุฏุงุฑุฉ ูุฏุงุฑุณ ุงููููู
""")

    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
        server.login(
            st.secrets["EMAIL_USER"],
            st.secrets["EMAIL_PASS"]
        )
        server.send_message(msg)

# ===============================
# ุฒุฑ ุงูุฅุฑุณุงู
# ===============================
st.subheader("๐ง ุฅุฑุณุงู ุงูุชูุงุฑูุฑ")

if st.button("๐ ุฅุฑุณุงู ุงูุชููููุงุช ููู ุงููุนููุงุช"):
    for _, row in df.iterrows():
        send_email(
            row["ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุนููุฉ"],
            row["ุงุณู ุงููุนููุฉ"],
            row["ุงูุชูููู ุงูุนุงู"],
            int(row["ุนุฏุฏ ุงูููุงูุต"])
        )
    st.success("โ ุชู ุฅุฑุณุงู ุฌููุน ุงูุชูุงุฑูุฑ ุจูุฌุงุญ")
