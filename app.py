import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

# ===============================
# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©
# ===============================
st.set_page_config(
    page_title="Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª",
    layout="wide"
)

st.title("ğŸ“ Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª â€“ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©")

# ===============================
# Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
# ===============================
uploaded_file = st.file_uploader(
    "ğŸ“‚ Ø§Ø±ÙØ¹ÙŠ Ù…Ù„Ù Excel (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Google Form)",
    type=["xlsx"]
)

if uploaded_file is not None:
    try:
        df = pd.read_excel(uploaded_file)
        df.columns = df.columns.str.strip()

        st.success("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­")

        # ===============================
        # ØªØ­Ø¯ÙŠØ¯ Ø£Ø¹Ù…Ø¯Ø© Ù†Ø¹Ù… / Ù„Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        # ===============================
        yes_no_cols = []
        for col in df.columns:
            values = df[col].astype(str).str.strip().unique()
            if any(v in ["Ù†Ø¹Ù…", "Ù„Ø§"] for v in values):
                yes_no_cols.append(col)

        # ===============================
        # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ
        # ===============================
        def count_missing(row):
            return sum(
                1 for c in yes_no_cols
                if str(row[c]).strip() == "Ù„Ø§"
            )

        df["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"] = df.apply(count_missing, axis=1)

        # ===============================
        # Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…
        # ===============================
        def evaluate(n):
            if n == 0:
                return "ğŸŒŸ Ù…Ù…ØªØ§Ø²"
            elif n <= 2:
                return "ğŸ™‚ Ø¬ÙŠØ¯"
            else:
                return "âš ï¸ ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©"

        df["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"] = df["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"].apply(evaluate)

        # ===============================
        # Ù…Ø¤Ø´Ø±Ø§Øª Ø¹Ø§Ù…Ø©
        # ===============================
        col1, col2, col3, col4 = st.columns(4)

        col1.metric("ğŸ‘©â€ğŸ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª", len(df))
        col2.metric("âŒ Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ Ø§Ù„ÙƒÙ„ÙŠ", int(df["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"].sum()))
        col3.metric("ğŸŒŸ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø§Øª", int((df["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"] == "ğŸŒŸ Ù…Ù…ØªØ§Ø²").sum()))
        col4.metric("âš ï¸ ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©", int((df["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"] == "âš ï¸ ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©").sum()))

        # ===============================
        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        # ===============================
        st.subheader("ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ")
        st.dataframe(df, use_container_width=True)

        # ===============================
        # Ø±Ø³Ù…: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ
        # ===============================
        st.subheader("ğŸ“ˆ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ Ù„ÙƒÙ„ Ù…Ø¹Ù„Ù…Ø©")

        if "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©" in df.columns:
            fig, ax = plt.subplots()
            ax.bar(df["Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©"], df["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"])
            plt.xticks(rotation=45, ha="right")
            ax.set_ylabel("Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ")
            ax.set_xlabel("Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©")
            st.pyplot(fig)
        else:
            st.warning("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…ÙˆØ¯ (Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©)")

        # ===============================
        # Ø±Ø³Ù…: Ù†Ø³Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        # ===============================
        st.subheader("ğŸ¥§ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…")

        rating_counts = df["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"].value_counts()
        fig2, ax2 = plt.subplots()
        ax2.pie(
            rating_counts,
            labels=rating_counts.index,
            autopct="%1.0f%%",
            startangle=90
        )
        ax2.axis("equal")
        st.pyplot(fig2)

        # ===============================
        # ØªØµØ¯ÙŠØ± Excel
        # ===============================
        st.subheader("â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±")

        export_df = df.copy()
        export_file = "ØªÙ‚Ø±ÙŠØ±_Ø£Ø¯Ø§Ø¡_Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª.xlsx"
        export_df.to_excel(export_file, index=False)

        with open(export_file, "rb") as f:
            st.download_button(
                "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Excel",
                f,
                file_name=export_file
            )

        # ===============================
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø¨Ø¯ÙˆÙ† SMTP)
        # ===============================
        st.subheader("ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª")

        if "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…Ø©" in df.columns:
            for _, row in df.iterrows():
                email = row["Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…Ø©"]
                name = row.get("Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©", "Ø§Ù„Ù…Ø¹Ù„Ù…Ø©")
                rating = row["Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…"]
                missing = row["Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ"]

                subject = "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ"
                body = f"""
Ù…Ø±Ø­Ø¨Ù‹Ø§ {name}

ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: {rating}
Ø¹Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ: {missing}

Ø´Ø§ÙƒØ±ÙŠÙ† ØªØ¹Ø§ÙˆÙ†Ùƒ ğŸŒ·
"""

                mailto_link = f"mailto:{email}?subject={subject}&body={body}"

                st.markdown(f"ğŸ“© [{name} â€“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…]({mailto_link})")
        else:
            st.warning("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")

    except Exception as e:
        st.error("âŒ Ø­ØµÙ„ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹")
        st.exception(e)

else:
    st.info("â¬†ï¸ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù")
