import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import smtplib
from email.message import EmailMessage

# ===============================
# ุฅุนุฏุงุฏ ุงูุตูุญุฉ
# ===============================
st.set_page_config(
    page_title="ููุญุฉ ูุชุงุจุนุฉ ุฃุฏุงุก ุงููุนููุงุช",
    layout="wide"
)

st.title("๐ ููุญุฉ ูุชุงุจุนุฉ ุฃุฏุงุก ุงููุนููุงุช โ ุงูุฅุฏุงุฑุฉ ุงูุชุนููููุฉ")

# ===============================
# ุฑูุน ููู ุงูุจูุงูุงุช
# ===============================
uploaded_file = st.file_uploader(
    "๐ ุงุฑูุนู ููู Excel (ุงูุจูุงูุงุช ุงููุงุฏูุฉ ูู Google Form)",
    type=["xlsx"]
)

if uploaded_file is None:
    st.info("โฌ๏ธ ูู ูุถูู ุงุฑูุนู ููู ุงูุจูุงูุงุช ูููุชุงุจุนุฉ")
    st.stop()

df = pd.read_excel(uploaded_file)

# ===============================
# ุชูุธูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
# ===============================
df = df.dropna(subset=["ุงุณู ุงููุนููุฉ"])
df["ุนุฏุฏ ุงูููุงูุต"] = pd.to_numeric(df["ุนุฏุฏ ุงูููุงูุต"], errors="coerce").fillna(0)

# ===============================
# ุงููุคุดุฑุงุช ุงูุนุงูุฉ
# ===============================
st.subheader("๐ ุงููุคุดุฑุงุช ุงูุนุงูุฉ")

col1, col2, col3, col4 = st.columns(4)

ุนุฏุฏ_ุงููุนููุงุช = df["ุงุณู ุงููุนููุฉ"].nunique()
ุนุฏุฏ_ุงูููุงูุต_ุงูููู = int(df["ุนุฏุฏ ุงูููุงูุต"].sum())
ุนุฏุฏ_ุงูููุชููุงุช = (df["ุงูุชูููู ุงูุนุงู"] == "๐ ููุชุงุฒ").sum()
ุนุฏุฏ_ูุญุชุงุฌ_ูุชุงุจุนุฉ = (df["ุงูุชูููู ุงูุนุงู"] == "โ๏ธ ูุญุชุงุฌ ูุชุงุจุนุฉ").sum()

col1.metric("๐ฉโ๐ซ ุนุฏุฏ ุงููุนููุงุช", ุนุฏุฏ_ุงููุนููุงุช)
col2.metric("โ ุนุฏุฏ ุงูููุงูุต ุงูููู", ุนุฏุฏ_ุงูููุงูุต_ุงูููู)
col3.metric("๐ ุงูููุชููุงุช", ุนุฏุฏ_ุงูููุชููุงุช)
col4.metric("โ๏ธ ูุญุชุงุฌ ูุชุงุจุนุฉ", ุนุฏุฏ_ูุญุชุงุฌ_ูุชุงุจุนุฉ)

# ===============================
# ุฌุฏูู ุงูุจูุงูุงุช
# ===============================
st.subheader("๐ ุฌุฏูู ุงููุชุงุจุนุฉ ุงูุชูุตููู")
st.dataframe(df, use_container_width=True)

# ===============================
# ุฑุณู ุชูุฒูุน ุงูููุงูุต
# ===============================
st.subheader("๐ ุชูุฒูุน ุงูููุงูุต ููู ูุนููุฉ")

df_plot = df[["ุงุณู ุงููุนููุฉ", "ุนุฏุฏ ุงูููุงูุต"]].copy()
df_plot["ุงุณู ุงููุนููุฉ"] = df_plot["ุงุณู ุงููุนููุฉ"].astype(str)
df_plot["ุนุฏุฏ ุงูููุงูุต"] = pd.to_numeric(df_plot["ุนุฏุฏ ุงูููุงูุต"], errors="coerce")
df_plot = df_plot.dropna()

fig, ax = plt.subplots(figsize=(10, 5))
ax.bar(df_plot["ุงุณู ุงููุนููุฉ"], df_plot["ุนุฏุฏ ุงูููุงูุต"])
ax.set_ylabel("ุนุฏุฏ ุงูููุงูุต")
ax.set_xlabel("ุงุณู ุงููุนููุฉ")
plt.xticks(rotation=45, ha="right")
st.pyplot(fig)

# ===============================
# ุฑุณู ุงูุชูููู ุงูุนุงู
# ===============================
st.subheader("๐ฅง ูุณุจุฉ ุงูุชูููู ุงูุนุงู")

status_counts = df["ุงูุชูููู ุงูุนุงู"].value_counts()

fig2, ax2 = plt.subplots()
ax2.pie(
    status_counts,
    labels=status_counts.index,
    autopct="%1.0f%%",
    startangle=90
)
ax2.axis("equal")
st.pyplot(fig2)

# ===============================
# ุฏุงูุฉ ุฅุฑุณุงู ุงูุฅูููู
# ===============================
def send_email(to_email, teacher_name, evaluation, missing_count):
    msg = EmailMessage()
    msg["Subject"] = "๐ ุชูุฑูุฑ ุงููุชุงุจุนุฉ ุงูุฃุณุจูุนู"
    msg["From"] = "YOUR_EMAIL@gmail.com"
    msg["To"] = to_email

    msg.set_content(f"""
ุงูุณูุงู ุนูููู {teacher_name}

ููุฏ ุฅูุงุฏุชู ุจูุชูุฌุฉ ุงููุชุงุจุนุฉ ุงูุฃุณุจูุนูุฉ:

๐น ุงูุชูููู ุงูุนุงู: {evaluation}
๐น ุนุฏุฏ ุงูููุงูุต: {missing_count}

ุดุงูุฑูู ูููุฏูุฑูู ุฌููุฏู ๐ธ
ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ
""")

    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
        server.login("YOUR_EMAIL@gmail.com", "APP_PASSWORD")
        server.send_message(msg)

# ===============================
# ุฒุฑ ุฅุฑุณุงู ุงูุฅููููุงุช
# ===============================
st.subheader("๐ง ุฅุฑุณุงู ุงูุชููููุงุช ุจุงูุจุฑูุฏ ุงูุฅููุชุฑููู")

if st.button("๐ ุฅุฑุณุงู ุงูุชูููู ููู ุงููุนููุงุช"):
    for _, row in df.iterrows():
        send_email(
            row["ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุนููุฉ"],
            row["ุงุณู ุงููุนููุฉ"],
            row["ุงูุชูููู ุงูุนุงู"],
            int(row["ุนุฏุฏ ุงูููุงูุต"])
        )

    st.success("โ ุชู ุฅุฑุณุงู ุฌููุน ุงูุชููููุงุช ุจูุฌุงุญ")
